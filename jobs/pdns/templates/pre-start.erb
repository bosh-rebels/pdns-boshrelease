#!/bin/bash
set -e

JOB_NAME=pdns
JOB_DIR="/var/vcap/jobs/$JOB_NAME"
STORE_DIR="/var/vcap/store/$JOB_NAME"
PACKAGE_DIR="/var/vcap/packages/$JOB_NAME"

mkdir -p "${STORE_DIR}"

<% if_p("sqlite.database") do |database| %>
  if [ ! -f "${STORE_DIR}/<%= database %>" ]; then
    /var/vcap/packages/sqlite/bin/sqlite3 "${STORE_DIR}/<%= database %>" < "${JOB_DIR}/seed/schema.sqlite3.sql"
  fi
<% end %>

set +e
set -x
# Running pdns and bosh-dns is not feasible
/var/vcap/bosh/bin/monit stop bosh-dns || true
/var/vcap/bosh/bin/monit stop bosh-dns-resolvconf || true
/var/vcap/bosh/bin/monit stop bosh-dns-healthcheck || true

